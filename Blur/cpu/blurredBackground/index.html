<html>

<style>
#input-area {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 20px;
  margin: 0 0 10px 0;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-segmentation"></script>

<script>
let srcImageData = null
let kernelSize = 10

let segmenter = null
let segmentationData = null

const init = async () => {
  const segmenterConfig = {
    runtime: 'mediapipe', 
    solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation',
    modelType: 'general'
  }
  const model = bodySegmentation.SupportedModels.MediaPipeSelfieSegmentation;
  segmenter = await bodySegmentation.createSegmenter(model, segmenterConfig);

  const input = document.getElementById('img-input')
  input.addEventListener('change', (e) => {
    const file = e.target.files[0]
    const reader = new FileReader()
    reader.addEventListener('load', (e) => {
      const data = reader.result
      const img = new Image()
      img.addEventListener('load', async () => {
        await initImageData(img)
        const imgCanvas = document.getElementById('img-canvas')
        imgCanvas.width = img.width
        imgCanvas.height = img.height
        imgCanvas.style.width = img.width + 'px'
        imgCanvas.style.height = img.height + 'px'
        drawImage()
      })
      img.src = data
    })
    reader.readAsDataURL(file)
  })

  const kernelSizeInput = document.getElementById('kernel-size-input')
  kernelSizeInput.addEventListener('change', (e) => {
    kernelSize = Number(e.target.value)
    drawImage()
  })
}

const initImageData = async (image) => {
  const bufferCanvas = document.createElement('canvas')
  bufferCanvas.width = image.width
  bufferCanvas.height = image.height
  const ctx = bufferCanvas.getContext('2d')
  ctx.drawImage(image, 0, 0, image.width, image.height)
  srcImageData = ctx.getImageData(0, 0, image.width, image.height)

  const startTime = performance.now()
  const segmentationResult = await segmenter.segmentPeople(image)
  segmentationData = await segmentationResult[0].mask.toImageData();
  const endTime = performance.now()
  console.log("Segmentation : " + (endTime - startTime) + "[ms]")
}

const drawImage = async () => {
  if (!(srcImageData && segmentationData)) {
    return
  }

  const message = document.getElementById('message')
  message.textContent = "in progress"
  await new Promise( (res) => setTimeout(()=>{res()}, 0))
  const startTime = performance.now()

  const w = srcImageData.width
  const h = srcImageData.height
  const dstImageData = new ImageData(w, h)

  for (let y = 0; y < h; ++y) {
    for (let x = 0; x < w; ++x) {
      const idx = (y * w + x) * 4
      let r = srcImageData.data[idx]
      let g = srcImageData.data[idx+1]
      let b = srcImageData.data[idx+2]
      let a = srcImageData.data[idx+3]

      const segValue = segmentationData.data[idx+3]
      if (segValue !== 255) {
        const blurRate = (1 - segValue / 255)
        const adjustedKernelSize = Math.floor(kernelSize * blurRate)
        let n = 0
        r = g = b = 0
        const kernelHalfSize = Math.floor(adjustedKernelSize / 2) + 1
        for (let ky = 0; ky <= adjustedKernelSize; ++ky) {
          for (let kx = 0; kx <= adjustedKernelSize; ++kx) {
            const refX = x + kx - kernelHalfSize;
            const refY = y + ky - kernelHalfSize;
            if (refX < 0 || w <= refX || refY < 0 || h <= refY ) {
              continue;
            }
            const refIdx = (refY * w + refX) * 4
            r += srcImageData.data[refIdx]
            g += srcImageData.data[refIdx+1]
            b += srcImageData.data[refIdx+2]
            ++n
          }
        }
        r = Math.floor(r/n)
        g = Math.floor(g/n)
        b = Math.floor(b/n)
      }

      dstImageData.data[idx] = r
      dstImageData.data[idx+1] = g
      dstImageData.data[idx+2] = b
      dstImageData.data[idx+3] = a
    }
  }

  const imgCanvas = document.getElementById('img-canvas')
  const imgCtx = imgCanvas.getContext('2d')
  imgCtx.putImageData(dstImageData, 0, 0)

  const endTime = performance.now()
  const time = Math.floor(endTime - startTime)
  const outputMessage = 'Kernel Size : ' + kernelSize + ', Time : ' + time + ' [ms]'
  console.log(outputMessage)
  message.textContent = outputMessage
}

</script>

<body onload="init()">
  <div id="main">
    <div id="input-area">
      <input type="file" id="img-input"/>
      <span>
        <span>Kernel Size</span>
        <input type="range" id="kernel-size-input" value="10" min="3" max="100"/>
      </span>
      <span id="message"></span>
    </div>
    <canvas id="img-canvas"></canvas>
  </div>
</body>

</html>
